<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Pac-Man Custom mit Avatar & 3 Geistern</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    canvas {
      display: block;
      margin: 10px auto;
      background: #000;
      border: 2px solid #444;
    }
  </style>
</head>
<body>
  <h2>Pac-Man Custom</h2>
  <p>Steuerung: Pfeiltasten oder WASD – sammle alle Zigaretten</p>
  <canvas id="game" width="640" height="640"></canvas>

  <script>
    // --- Grundeinstellungen ---
    var TILE = 32;
    var COLS = 20;
    var ROWS = 20;

    var canvas = document.getElementById("game");
    var ctx = canvas.getContext("2d");

    // Avatar-Bild laden (avatar.png im selben Ordner)
    var avatar = new Image();
    var avatarLoaded = false;
    avatar.onload = function() { avatarLoaded = true; };
    avatar.src = "avatar.jpeg"; // <- hier kannst du auch einen anderen Dateinamen einsetzen

    // Karte: # = Wand, . = Zigarette, C = Schachtel, Leer = leer
    var rawMap = [
      "####################",
      "#........##........#",
      "#.####.#.##.#.####.#",
      "#C#  #.#....#.#  #C#",
      "#.####.######.####.#",
      "#..................#",
      "#.####.##..##.####.#",
      "#.#  #.##..##.#  #.#",
      "#.##.#.######.#.##.#",
      "#....#....##....#..#",
      "######.######.######",
      "#....#....##....#..#",
      "#.##.#.######.#.##.#",
      "#.#  #.##..##.#  #.#",
      "#.####.##..##.####.#",
      "#..................#",
      "#.####.######.####.#",
      "#C#  #....##....#  #",
      "#.####.######.####.#",
      "####################"
    ];

    // 0 = leer, 1 = Wand, 2 = Zigarette, 3 = Schachtel
    var map = [];
    var y, x, c;
    function loadMap() {
      map = [];
      for (y = 0; y < ROWS; y++) {
        var row = [];
        for (x = 0; x < COLS; x++) {
          c = rawMap[y].charAt(x);
          if (c === "#") row.push(1);
          else if (c === ".") row.push(2);
          else if (c === "C") row.push(3);
          else row.push(0);
        }
        map.push(row);
      }
    }
    loadMap();

   // Spieler
var player = {
  x: 10.5 * TILE,
  y: 15.5 * TILE,
  size: 28,        // Physik-Größe (für Kollision)
  renderScale: 1.6, // Anzeige-Größe (1.0 = normal, >1 = größer)
  speed: 2.2
};


    // Drei Geister
    var ghosts = [
      { x:  9.5 * TILE, y:  9.5 * TILE, dx: 1, dy: 0, speed: 1.6, color: "red"   },
      { x:  7.5 * TILE, y:  9.5 * TILE, dx: 1, dy: 0, speed: 1.5, color: "pink"  },
      { x: 12.5 * TILE, y:  9.5 * TILE, dx: 1, dy: 0, speed: 1.4, color: "cyan"  }
    ];

    var score = 0;
    var lives = 3;

    // Tasten
    var keys = {};
    document.addEventListener("keydown", function(e) {
      keys[e.key] = true;
    });
    document.addEventListener("keyup", function(e) {
      keys[e.key] = false;
    });

    // --- Hilfsfunktionen ---
    function tileIsWall(tx, ty) {
      if (tx < 0 || ty < 0 || tx >= COLS || ty >= ROWS) return true;
      return map[ty][tx] === 1;
    }

    function canMove(nx, ny, size) {
      var r = size / 2;
      var points = [
        { x: nx - r, y: ny - r },
        { x: nx + r, y: ny - r },
        { x: nx - r, y: ny + r },
        { x: nx + r, y: ny + r }
      ];
      for (var i = 0; i < points.length; i++) {
        var p = points[i];
        var tx = Math.floor(p.x / TILE);
        var ty = Math.floor(p.y / TILE);
        if (tileIsWall(tx, ty)) return false;
      }
      return true;
    }

    function randomDir() {
      var dirs = [
        { x: 1, y: 0 },
        { x: -1, y: 0 },
        { x: 0, y: 1 },
        { x: 0, y: -1 }
      ];
      return dirs[Math.floor(Math.random() * dirs.length)];
    }

    function dist2(ax, ay, bx, by) {
      var dx = ax - bx;
      var dy = ay - by;
      return dx * dx + dy * dy;
    }

    // --- Update-Funktionen ---
    function updatePlayer() {
      var dx = 0;
      var dy = 0;

      if (keys["w"] || keys["ArrowUp"]) dy = -1;
      if (keys["s"] || keys["ArrowDown"]) dy =  1;
      if (keys["a"] || keys["ArrowLeft"]) dx = -1;
      if (keys["d"] || keys["ArrowRight"]) dx =  1;

      if (dx !== 0 && dy !== 0) {
        dx *= Math.SQRT1_2;
        dy *= Math.SQRT1_2;
      }

      var nx = player.x + dx * player.speed;
      var ny = player.y + dy * player.speed;

      if (canMove(nx, player.y, player.size)) player.x = nx;
      if (canMove(player.x, ny, player.size)) player.y = ny;

      pickupItem();
    }

    function pickupItem() {
      var tx = Math.floor(player.x / TILE);
      var ty = Math.floor(player.y / TILE);
      if (tx < 0 || ty < 0 || tx >= COLS || ty >= ROWS) return;

      var v = map[ty][tx];
      if (v === 2 || v === 3) {
        if (v === 2) score += 10;  // Zigarette
        if (v === 3) score += 50;  // Schachtel
        map[ty][tx] = 0;

        // Check: noch Items?
        var anyLeft = false;
        for (y = 0; y < ROWS; y++) {
          for (x = 0; x < COLS; x++) {
            if (map[y][x] === 2 || map[y][x] === 3) {
              anyLeft = true;
              break;
            }
          }
          if (anyLeft) break;
        }
        if (!anyLeft) {
          alert("Alle Zigaretten gesammelt! Punkte: " + score);
          resetGame();
        }
      }
    }

    function resetGame() {
      loadMap();
      player.x = 10.5 * TILE;
      player.y = 15.5 * TILE;

      ghosts[0].x = 9.5 * TILE;  ghosts[0].y = 9.5 * TILE;  ghosts[0].dx = 1; ghosts[0].dy = 0;
      ghosts[1].x = 7.5 * TILE;  ghosts[1].y = 9.5 * TILE;  ghosts[1].dx = 1; ghosts[1].dy = 0;
      ghosts[2].x = 12.5 * TILE; ghosts[2].y = 9.5 * TILE;  ghosts[2].dx = 1; ghosts[2].dy = 0;

      score = 0;
      lives = 3;
    }

    function updateGhost(g) {
      // einfache „intelligente“ Richtung: manchmal neu wählen
      if (Math.random() < 0.03) {
        var bestDir = null;
        var bestDist = 99999999;
        var dirs = [
          { x: 1, y: 0 },
          { x: -1, y: 0 },
          { x: 0, y: 1 },
          { x: 0, y: -1 }
        ];
        for (var i = 0; i < dirs.length; i++) {
          var d = dirs[i];
          // nicht direkt umdrehen
          if (-d.x === g.dx && -d.y === g.dy) continue;
          var nx = g.x + d.x * g.speed;
          var ny = g.y + d.y * g.speed;
          if (!canMove(nx, ny, TILE * 0.8)) continue;
          var dx = (player.x - nx);
          var dy = (player.y - ny);
          var dist = dx * dx + dy * dy;
          if (dist < bestDist) {
            bestDist = dist;
            bestDir = d;
          }
        }
        if (bestDir) {
          g.dx = bestDir.x;
          g.dy = bestDir.y;
        }
      }

      var gxNew = g.x + g.dx * g.speed;
      var gyNew = g.y + g.dy * g.speed;

      if (canMove(gxNew, gyNew, TILE * 0.8)) {
        g.x = gxNew;
        g.y = gyNew;
      } else {
        // gegen Wand: zufällige neue Richtung
        var nd = randomDir();
        g.dx = nd.x;
        g.dy = nd.y;
      }

      // Kollision mit Spieler?
      var gdx = g.x - player.x;
      var gdy = g.y - player.y;
      var d2 = gdx * gdx + gdy * gdy;
      if (d2 < (player.size * player.size) / 4) {
        lives--;
        if (lives <= 0) {
          alert("GAME OVER – Punkte: " + score);
          resetGame();
        } else {
          // Spieler zurücksetzen
          player.x = 10.5 * TILE;
          player.y = 15.5 * TILE;
        }
      }
    }

    // --- Zeichnen ---
    function drawMap() {
      for (y = 0; y < ROWS; y++) {
        for (x = 0; x < COLS; x++) {
          var v = map[y][x];
          // Hintergrund
          if (v === 1) ctx.fillStyle = "#002244";
          else ctx.fillStyle = "#000011";
          ctx.fillRect(x * TILE, y * TILE, TILE, TILE);

          // Zigarette
          if (v === 2) {
            ctx.fillStyle = "white";
            ctx.fillRect(x * TILE + 10, y * TILE + 14, 14, 4);
            ctx.fillStyle = "orange";
            ctx.fillRect(x * TILE + 22, y * TILE + 14, 4, 4);
          }
          // Schachtel
          if (v === 3) {
            ctx.fillStyle = "white";
            ctx.fillRect(x * TILE + 6, y * TILE + 6, 20, 20);
            ctx.fillStyle = "red";
            ctx.fillRect(x * TILE + 6, y * TILE + 6, 20, 6);
          }
        }
      }
    }

    function drawPlayer() {
  // Physik-Größe bleibt gleich, Anzeige-Größe wird skaliert
  var displaySize = player.size * (player.renderScale || 1.0);
  var r = displaySize / 2;

  if (avatarLoaded) {
    // Kopf als Avatar-Bild, kreisförmig maskiert
    ctx.save();
    ctx.beginPath();
    ctx.arc(player.x, player.y, r, 0, Math.PI * 2);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(avatar, player.x - r, player.y - r, displaySize, displaySize);
    ctx.restore();

    // kleiner gelber Rand
    ctx.strokeStyle = "yellow";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(player.x, player.y, r, 0, Math.PI * 2);
    ctx.stroke();
  } else {
    // Fallback: klassischer gelber Kreis
    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.arc(player.x, player.y, r, 0, Math.PI * 2);
    ctx.fill();
  }
}


    function drawGhosts() {
      for (var i = 0; i < ghosts.length; i++) {
        var g = ghosts[i];
        ctx.fillStyle = g.color;
        ctx.beginPath();
        ctx.arc(g.x, g.y, TILE * 0.4, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function drawHUD() {
      ctx.fillStyle = "white";
      ctx.font = "16px Arial";
      ctx.fillText("Punkte: " + score, 10, 20);
      ctx.fillText("Leben: " + lives, 10, 40);
    }

    // --- Hauptschleife ---
    function loop() {
      updatePlayer();
      for (var i = 0; i < ghosts.length; i++) {
        updateGhost(ghosts[i]);
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap();
      drawGhosts();
      drawPlayer();
      drawHUD();

      requestAnimationFrame(loop);
    }

    // Start
    loop();
  </script>
</body>
</html>
